<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Binary Cam Translator AR (Framed)</title>
<style>
  body { margin:0; background:#000; font-family: system-ui, -apple-system, Segoe UI, Roboto; color:#eaeaea; }
  .container { position:relative; width:100vw; height:100vh; overflow:hidden; }
  video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }

  /* Overlay canvas (solo dibuja UI y texto) */
  canvas { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

  /* Panel inferior de salida */
  .bottom {
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:14px; width:min(920px, calc(100% - 24px));
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.18);
    border-radius:16px; padding:10px 12px;
    backdrop-filter: blur(6px);
  }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  button {
    background:#222; color:#eaeaea; border:1px solid #333; border-radius:12px;
    padding:8px 12px; font-size:14px; cursor:pointer;
  }
  button:disabled { opacity:.5; cursor:default; }
  .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
  .pill { padding:3px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.35); font-size:13px; }
  .out {
    margin-top:8px; padding:10px 12px;
    border-radius:14px; border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.35);
    font-size:18px;
  }
  .hint { font-size:13px; opacity:.8; }
</style>
</head>

<body>
<div class="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>

  <div class="bottom">
    <div class="row">
      <button id="start">Iniciar</button>
      <button id="stop" disabled>Parar</button>
      <span id="status" class="pill">Listo</span>
      <span class="pill hint">Apunta el binario dentro del marco</span>
    </div>

    <div class="out mono" id="txtOut">(traducción aquí)</div>
    <div class="hint mono" id="binOut" style="margin-top:8px; opacity:.65;"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');

const btnStart = document.getElementById('start');
const btnStop  = document.getElementById('stop');
const statusEl = document.getElementById('status');
const txtOut = document.getElementById('txtOut');
const binOut = document.getElementById('binOut');

let stream = null;
let worker = null;
let scanning = false;

// Tamaño y posición del “marco” (ROI) en proporción a la pantalla
// Ajusta si lo quieres más grande/pequeño o más arriba/abajo:
const ROI = {
  wPct: 0.82,   // ancho del marco (82% del ancho pantalla)
  hPct: 0.18,   // alto del marco (18% del alto pantalla)
  yPct: 0.42    // centro vertical del marco (0.5 = centro pantalla)
};

function setStatus(s){ statusEl.textContent = s; }

function resizeCanvas() {
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

async function initOCR() {
  setStatus("Cargando OCR…");
  worker = await Tesseract.createWorker();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  await worker.setParameters({
    tessedit_char_whitelist: '01 ',
    preserve_interword_spaces: '1'
  });
  setStatus("OCR listo");
}

function roiRect() {
  const w = Math.floor(canvas.width  * ROI.wPct);
  const h = Math.floor(canvas.height * ROI.hPct);
  const x = Math.floor((canvas.width - w) / 2);
  const y = Math.floor((canvas.height * ROI.yPct) - (h / 2));
  return { x, y, w, h };
}

function drawUI(translatedText) {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const {x,y,w,h} = roiRect();

  // Marco
  ctx.lineWidth = 3;
  ctx.strokeStyle = "rgba(0,255,120,0.85)";
  ctx.strokeRect(x, y, w, h);

  // “corners” (más estilo escáner)
  const c = 18;
  ctx.lineWidth = 5;
  ctx.strokeStyle = "rgba(0,255,120,0.95)";
  // TL
  ctx.beginPath(); ctx.moveTo(x, y+c); ctx.lineTo(x, y); ctx.lineTo(x+c, y); ctx.stroke();
  // TR
  ctx.beginPath(); ctx.moveTo(x+w-c, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y+c); ctx.stroke();
  // BL
  ctx.beginPath(); ctx.moveTo(x, y+h-c); ctx.lineTo(x, y+h); ctx.lineTo(x+c, y+h); ctx.stroke();
  // BR
  ctx.beginPath(); ctx.moveTo(x+w-c, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h-c); ctx.stroke();

  // Texto “traducido” justo debajo del marco (overlay)
  if (translatedText && translatedText.length >= 2) {
    ctx.font = '28px ui-monospace, Menlo, Consolas, monospace';
    ctx.fillStyle = 'rgba(0,255,120,0.92)';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    // Sombra sutil para legibilidad
    ctx.shadowColor = 'rgba(0,0,0,0.75)';
    ctx.shadowBlur = 8;
    ctx.fillText(translatedText, x + w/2, y + h + 10);
    ctx.shadowBlur = 0;
  }
}

// Limpieza OCR
function cleanBinary(t) {
  return t
    .replace(/[oO]/g,'0')
    .replace(/[iIlL]/g,'1')
    .replace(/[^01 ]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}

function binaryToAscii(bin) {
  const bits = bin.replace(/\s+/g,'');
  let out = '';
  for (let i=0;i+8<=bits.length;i+=8) {
    const byte = bits.slice(i,i+8);
    const code = parseInt(byte,2);
    if (code === 32) out += ' ';
    else if (code >= 33 && code <= 126) out += String.fromCharCode(code);
  }
  return out;
}

// Captura ROI del vídeo y lo pasa al OCR
async function scanOnce() {
  if (!stream || scanning) return;
  if (!video.videoWidth || !video.videoHeight) return;

  scanning = true;
  try {
    setStatus("Leyendo…");

    // Creamos canvas temporal con el frame del vídeo (a resolución nativa del stream)
    const tmp = document.createElement('canvas');
    tmp.width = video.videoWidth;
    tmp.height = video.videoHeight;
    const tctx = tmp.getContext('2d', { willReadFrequently:true });
    tctx.drawImage(video, 0, 0);

    // Convertimos ROI de coords pantalla -> coords vídeo
    // (asumiendo object-fit:cover; aproximación razonable)
    // Para máxima precisión habría que calcular el recorte de cover exacto.
    const {x,y,w,h} = roiRect();
    const sx = Math.max(0, Math.floor(x / canvas.width  * tmp.width));
    const sy = Math.max(0, Math.floor(y / canvas.height * tmp.height));
    const sw = Math.min(tmp.width  - sx, Math.floor(w / canvas.width  * tmp.width));
    const sh = Math.min(tmp.height - sy, Math.floor(h / canvas.height * tmp.height));

    // Recortamos ROI a un canvas pequeño (mejor para OCR)
    const roi = document.createElement('canvas');
    roi.width = sw; roi.height = sh;
    const rctx = roi.getContext('2d', { willReadFrequently:true });
    rctx.drawImage(tmp, sx, sy, sw, sh, 0, 0, sw, sh);

    // Umbral simple (blanco/negro) para ayudar al OCR
    const img = rctx.getImageData(0,0,sw,sh);
    const d = img.data;
    for (let i=0;i<d.length;i+=4){
      const lum = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
      const v = lum > 150 ? 255 : 0;
      d[i]=d[i+1]=d[i+2]=v;
    }
    rctx.putImageData(img,0,0);

    const { data } = await worker.recognize(roi);
    const bin = cleanBinary(data.text || '');
    const txt = binaryToAscii(bin);

    // UI
    binOut.textContent = bin ? `BIN: ${bin}` : "";
    txtOut.textContent = txt ? txt : "(sin lectura)";
    drawUI(txt);

    setStatus(txt ? "OK" : "Apunta mejor");
  } catch (e) {
    console.error(e);
    setStatus("Error");
  } finally {
    scanning = false;
  }
}

// Loop
let loopTimer = null;
function startLoop() {
  if (loopTimer) clearInterval(loopTimer);
  loopTimer = setInterval(scanOnce, 1100);
}
function stopLoop() {
  if (loopTimer) clearInterval(loopTimer);
  loopTimer = null;
}

async function start() {
  if (!navigator.mediaDevices?.getUserMedia) {
    setStatus("Sin cámara");
    return;
  }
  btnStart.disabled = true;

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  });
  video.srcObject = stream;

  resizeCanvas();
  drawUI("");

  if (!worker) await initOCR();

  btnStop.disabled = false;
  setStatus("Apunta al marco");
  startLoop();
}

function stop() {
  stopLoop();
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  video.srcObject = null;
  btnStart.disabled = false;
  btnStop.disabled = true;
  setStatus("Parado");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  txtOut.textContent = "(traducción aquí)";
  binOut.textContent = "";
}

btnStart.onclick = start;
btnStop.onclick = stop;

resizeCanvas();
drawUI("");
</script>
</body>
</html>
